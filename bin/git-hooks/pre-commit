#!/usr/bin/env python3
"""
Pre-commit hook: Validate YAML syntax before commit.

This hook validates all staged YAML files in the yaml/ directory
against the JSON schema to catch issues early in the development process.

Exit codes:
    0: All YAML files valid
    1: Validation errors found
    2: Hook setup error (no poetry, etc.)
"""

import subprocess
import sys
import os
from pathlib import Path

def run_command(cmd):
    """Execute a shell command and return exit code."""
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
        print(result.stdout, file=sys.stdout, end='')
        print(result.stderr, file=sys.stderr, end='')
        return result.returncode
    except Exception as e:
        print(f"ERROR: Failed to execute command: {e}", file=sys.stderr)
        return 2

def main():
    """Main hook logic."""
    # Get repository root
    repo_root = subprocess.check_output(
        ['git', 'rev-parse', '--show-toplevel'],
        text=True
    ).strip()
    
    os.chdir(repo_root)
    
    # Get staged YAML files in yaml/ directory
    try:
        result = subprocess.run(
            ['git', 'diff', '--cached', '--name-only', '--diff-filter=ACM', 'yaml/'],
            capture_output=True,
            text=True,
            check=True
        )
        staged_files = result.stdout.strip().split('\n')
        staged_yaml_files = [f for f in staged_files if f.endswith('.yaml') and f]
    except subprocess.CalledProcessError:
        staged_yaml_files = []
    
    if not staged_yaml_files:
        print("✓ No YAML files to validate")
        return 0
    
    print(f"Validating {len(staged_yaml_files)} YAML file(s)...")
    
    # Validate using bin/validate.py
    validation_cmd = f"poetry run python bin/validate.py -v {' '.join(staged_yaml_files)}"
    exit_code = run_command(validation_cmd)
    
    if exit_code == 0:
        print("✓ All YAML files valid")
    else:
        print("\n❌ YAML validation failed. Please fix errors before committing.")
        print("To bypass this hook: git commit --no-verify")
    
    return exit_code

if __name__ == '__main__':
    sys.exit(main())
